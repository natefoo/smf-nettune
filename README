nddtune
=======

This script/manifest allows you to define parameters tunable by ndd which can
then be applied and unapplied through Solaris SMF.

Based on the original concept by Hung-Sheng Tsao:

  http://blogs.sun.com/hstsao/entry/smf_and_tcp_tuning

My enhancements place ndd parameters directly into SMF instead of hardcoded in
the method as in the original.

The tuning values in this example are from:

  http://www.psc.edu/networking/projects/tcptune/historical.php#Solaris

usage
-----

1. Copy the nddtune script to somewhere appropriate for your environment and
   make sure it is executable.  By default, the SMF config expects to find it
   in /lib/svc/method.

2. Copy network-nddtune.xml to /var/svc/manifest/site.  Edit the XML config
   file if you put nddtune somewhere other than /lib/svc/method.

3. Import the manifest:

    # svccfg import /var/svc/manifest/site/network-nddtune.xml

4. Create property groups for the devices you wish to tune.  The property group
   is translated to the device passed to ndd by prepending a slash and
   converting underscores to slashes, so in this example dev_tcp will result in
   'ndd -set /dev/tcp ...':

    # svccfg -s nddtune addpg dev_tcp application

5. Set some parameters:

    # svccfg -s nddtune setprop dev_tcp/tcp_xmit_hiwat = integer: 4000000
    # svccfg -s nddtune setprop dev_tcp/tcp_recv_hiwat = integer: 4000000
    # svccfg -s nddtune setprop dev_tcp/tcp_max_buf = integer: 4000000
    # svccfg -s nddtune setprop dev_tcp/tcp_cwnd_max = integer: 4000000

6. Create an SMF snapshot that includes your new values:

    # svcadm refresh nddtune

7. Check your current values before enabling:

    % ndd -get /dev/tcp tcp_xmit_hiwat
    49152
    % ndd -get /dev/tcp tcp_recv_hiwat
    49152
    % ndd -get /dev/tcp tcp_max_buf
    1048576
    % ndd -get /dev/tcp tcp_cwnd_max
    1048576

8. Enable the service.

    # svcadm enable nddtune

9. Check the new values to make sure it worked:

    % ndd -get /dev/tcp tcp_xmit_hiwat                                                                                                                                                                                                                                                                            
    4000000
    % ndd -get /dev/tcp tcp_recv_hiwat
    4000000
    % ndd -get /dev/tcp tcp_max_buf
    4000000
    % ndd -get /dev/tcp tcp_cwnd_max
    4000000

10. You can disable the service to reset the tunables to their previous values,
    since the previous values are stored whenever the service is enabled.
    These previous values are stored in an SMF property group named like the
    one(s) you created, but with '_defaults' appended:

    % /usr/bin/svcprop -p dev_tcp_defaults nddtune
    dev_tcp_defaults/tcp_xmit_hiwat integer 49152
    dev_tcp_defaults/tcp_recv_hiwat integer 49152
    dev_tcp_defaults/tcp_max_buf integer 1048576
    dev_tcp_defaults/tcp_cwnd_max integer 1048576
